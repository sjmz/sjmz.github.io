---
layout: post
title: "hlist_for_each_entry, offsetof, padding and CVE-2016-4486"
date: 2025-09-14
---

I was reading some netlink code, specifically, I was trying to understand construction of responses due to a RTM_GETLINK request.
I suggest you reading [this]({% post_url 2025-09-12-netlink_nonsql %}) blogpost where netlink sockets and messages are introduced and explored so you can get a feeling for this.
As an attempt to understand the netlink codebase better for then writing about it, I strumbled across different interesting ideas that I want to share.

# **// rtnl_register**

In the last blogpost we made an ip clone which, by sending a proper netlink packet, was able to extract information about network interfaces such as lo and wlp1s0.

`netlink_kernel_create` is the function in charge of instantiating a kernel netlink socket.
The one specific for the routing subsystem is created inside the `rtnetlink_net_init` function.
Among other things, it sets a callback that serves as a handler for the messages sent to this socket.
This handler is the `rtnetlink_rcv` function.

In reality, `rtnetlink_rcv` doesn't treat the specific packets, but it dispatches specific handlers based on request tipology and the flags associated with it.

`rtnl_register` does exactly this.
Inside net/core/rtnetlink.c, `rtnl_register` is called multiple times with different arguments.
```c
void __init rtnetlink_init(void)
{
	[...]

	rtnl_register(PF_UNSPEC, RTM_GETLINK, rtnl_getlink, rtnl_dump_ifinfo, 0);
	rtnl_register(PF_UNSPEC, RTM_SETLINK, rtnl_setlink, NULL, 0);
	rtnl_register(PF_UNSPEC, RTM_NEWLINK, rtnl_newlink, NULL, 0);
	rtnl_register(PF_UNSPEC, RTM_DELLINK, rtnl_dellink, NULL, 0);

	rtnl_register(PF_UNSPEC, RTM_GETADDR, NULL, rtnl_dump_all, 0);
	rtnl_register(PF_UNSPEC, RTM_GETROUTE, NULL, rtnl_dump_all, 0);

	[...]
}
```

`rtnl_register(PF_UNSPEC, RTM_GETLINK, rtnl_getlink, rtnl_dump_ifinfo, 0)` is the call that sets the specific handlers for RTM_GETLINK requests.
The one of interest for now is the `rtnl_dump_ifinfo`, which is called upon receiving a request with the NLM_F_DUMP flag set.
